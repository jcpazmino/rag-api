# rag-api
## Tabla de Contenidos

- [Visi√≥n General](#visi√≥n-general)
- [Arquitectura General](#arquitectura-general)
- [Componentes Principales](#componentes-principales)
- [Modelo de Datos](#modelo-de-datos)
- [Flujos de Procesos](#flujos-de-procesos)
- [Integraciones y Dependencias](#integraciones-y-dependencias)
- [Consideraciones de Seguridad](#consideraciones-de-seguridad)
- [Escalabilidad y Mantenimiento](#escalabilidad-y-mantenimiento)
- [Diagramas Mermaid](#diagramas-mermaid)
- [Glosario](#glosario)

---

## Project Overview
This project is a RESTful API designed to handle embedding functionalities and querying operations. It provides endpoints for processing and managing data, particularly focusing on embeddings and PDF file handling.

## File Structure
La estructura del proyecto es la siguiente:

```
rag-api/
‚îú‚îÄ‚îÄ .env                      # Variables de entorno de la aplicaci√≥n
‚îú‚îÄ‚îÄ app.js                    # Punto de entrada principal de la aplicaci√≥n
‚îú‚îÄ‚îÄ routes/                   # Definici√≥n de rutas de la API
‚îÇ   ‚îú‚îÄ‚îÄ documents.js              # Rutas para gesti√≥n de documentos
‚îÇ   ‚îú‚îÄ‚îÄ documentChunks.js         # Rutas para gesti√≥n de fragmentos/chunks de documentos
‚îÇ   ‚îú‚îÄ‚îÄ embed.js                  # Rutas para procesamiento y subida de embeddings/PDF
‚îÇ   ‚îú‚îÄ‚îÄ query.js                  # Rutas para consultas sem√°nticas y gesti√≥n de colecciones
‚îÇ   ‚îî‚îÄ‚îÄ index.js                  # (Opcional) Archivo para centralizar y exportar rutas
‚îú‚îÄ‚îÄ services/                 # L√≥gica de negocio y acceso a datos
‚îÇ   ‚îú‚îÄ‚îÄ rag/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chromaService.js         # Interacci√≥n con ChromaDB
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ documentService.js       # L√≥gica de documentos y base de datos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ documentChunkService.js  # L√≥gica para gesti√≥n de fragmentos/chunks de documentos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ embeddingService.js      # Procesamiento y almacenamiento de embeddings
‚îÇ   ‚îú‚îÄ‚îÄ pdfService.js                # Procesamiento de archivos PDF (fuera de rag/)
‚îÇ   ‚îî‚îÄ‚îÄ mysqlService.js              # Servicio de conexi√≥n y utilidades para MySQL
‚îú‚îÄ‚îÄ utils/                    # Funciones utilitarias
‚îÇ   ‚îî‚îÄ‚îÄ chunker.js                # Fragmentaci√≥n de texto en chunks
‚îú‚îÄ‚îÄ data/                     # Almacenamiento de datos
‚îÇ   ‚îî‚îÄ‚îÄ uploads/                  # Archivos PDF subidos por los usuarios
‚îú‚îÄ‚îÄ docs/                     # Documentaci√≥n t√©cnica y de endpoints
‚îÇ   ‚îî‚îÄ‚îÄ query.md                  # Documentaci√≥n de las rutas de consulta sem√°ntica
‚îÇ   ‚îî‚îÄ‚îÄ documents.md          # Documentaci√≥n de las rutas y l√≥gica de gesti√≥n de documentos
‚îÇ   ‚îî‚îÄ‚îÄ embed.md              # Documentaci√≥n de las rutas y l√≥gica de embeddings
‚îÇ   ‚îî‚îÄ‚îÄ documentChunks.md     # Documentaci√≥n de la gesti√≥n de fragmentos/chunks de documentos
‚îú‚îÄ‚îÄ embeddings.json           # Almacenamiento temporal de embeddings
‚îú‚îÄ‚îÄ package.json              # Configuraci√≥n de npm y dependencias
‚îî‚îÄ‚îÄ README.md                 # Documentaci√≥n principal del proyecto
```

## Setup Instructions
1. Clone the repository to your local machine.
2. Navigate to the project directory.
3. Create a `.env` file and populate it with the necessary environment variables.
4. Run `npm install` to install the required dependencies.
5. Start the application using `node app.js`.

## Usage Guidelines
- Use the `/embed` route to handle embedding requests.
- Use the `/query` route to perform queries on the data.
- Uploaded PDF files should be placed in the `data/uploads` directory.

## Contributing
Contributions are welcome! Please submit a pull request or open an issue for any enhancements or bug fixes.

# RAG API ‚Äì OpenAI + ChromaDB

API REST en Node.js para procesar documentos PDF, generar embeddings con OpenAI y realizar b√∫squedas sem√°nticas usando ChromaDB.

## üöÄ Funcionalidades

- üìÑ Carga de PDF y fragmentaci√≥n por tokens (precisi√≥n real con tiktoken)
- üß† Generaci√≥n de embeddings con OpenAI
- üóÉÔ∏è Almacenamiento en ChromaDB con metadatos
- üîç B√∫squeda sem√°ntica por lenguaje natural (consultas con contexto)

## üì¶ Requisitos

- Node.js 18+
- Docker (para ChromaDB)
- Clave de API de OpenAI

## üîß Instalaci√≥n

```bash
git clone https://github.com/jcpazmino/rag-api.git
cd rag-api
npm install
cp .env.example .env
# Edita .env con tu API key de OpenAI
```

### üö¢ Ejecutar ChromaDB

```bash
docker run -d -p 8000:8000 ghcr.io/chroma-core/chroma:latest
```

## üß™ Endpoints

### POST `/embed-pdf`

Carga un PDF, lo fragmenta, genera embeddings y los guarda en Chroma.

**Body (form-data):**
- `pdf`: archivo PDF

**Respuesta:**
```json
{
  "message": "‚úÖ 20 fragmentos procesados y almacenados en Chroma."
}
```

---

### POST `/query`

Env√≠a una pregunta y recibe los fragmentos m√°s relevantes del PDF.

**Body (JSON):**
```json
{
  "pregunta": "¬øCu√°les son los principios del curr√≠culo?"
}
```

**Respuesta:**
```json
{
  "pregunta": "...",
  "resultados": [
    { "texto": "...", "score": 0.13 },
    ...
  ]
}
```

---

## üìÅ Estructura del proyecto

```
rag-api/
‚îú‚îÄ‚îÄ routes/
‚îú‚îÄ‚îÄ services/
‚îú‚îÄ‚îÄ utils/
‚îú‚îÄ‚îÄ data/uploads/
‚îú‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ app.js
‚îî‚îÄ‚îÄ package.json
```

---

## üß† Stack

- Express.js
- OpenAI Embeddings
- ChromaDB (REST)
- pdf-parse + tiktoken

---

## üìú Licencia

MIT

## Databases Used

This application uses two main databases:

1. **ChromaDB**  
   - Vector database for storing and querying embeddings and metadata of document fragments.
   - Accessed via its REST API (default: `http://localhost:8000`).
   - Used for semantic search and context retrieval.

2. **MySQL**  
   - Relational database for storing structured information about documents and their fragments (tables like `documents` and `document_chunks`).
   - Accessed via the `mysql2` client from Node.js.
   - Used for administration, querying, and management of documents and their structured metadata.

**Summary:**  
The app uses **ChromaDB** for embeddings and semantic search, and **MySQL** for structured document and fragment management.

## ChromaDB Setup

The command to create and run a ChromaDB container using Docker is:

```sh
docker run -d -p 8000:8000 ghcr.io/chroma-core/chroma:latest
```

By default, the ChromaDB REST API will be available at `http://localhost:8000`.

**Database name used in ChromaDB:**  
The application uses the database named:

```
rag_api
```

This is set via the environment variable `CHROMA_DATABASE=rag_api` in your `.env` file.
**To create the database in PowerShell:**
```powershell
curl -Method POST http://localhost:8000/api/v2/tenants/default_tenant/databases `
  -Headers @{"Content-Type"="application/json"} `
  -Body '{"name": "rag_api"}'
```

**To validate if the database exists:**
```powershell
curl http://localhost:8000/api/v2/tenants/default_tenant/databases
```

## Reiniciar la colecci√≥n en ChromaDB

Para reiniciar la colecci√≥n `documentos_rag` (eliminarla y crearla de nuevo) usando el endpoint expuesto por la API, ejecuta el siguiente comando desde la terminal:

```powershell
curl -X POST http://localhost:3000/query/reiniciar-coleccion
```
```terminal
curl.exe -X POST http://localhost:3000/query/reiniciar-coleccion
```

Aseg√∫rate de que tu API est√© corriendo y que el puerto (`3000`) corresponda al configurado en tu aplicaci√≥n.

## MySQL Setup

The command to create and run a MySQL container using Docker is:

```sh
docker run --name mysql-RAG -e MYSQL_ROOT_PASSWORD=1234 -e MYSQL_DATABASE=ragdb -p 3306:3306 -d mysql:8
```

- `--name mysql-RAG` ‚Üí container name
- `-e MYSQL_ROOT_PASSWORD=1234` ‚Üí root user password
- `-e MYSQL_DATABASE=ragdb` ‚Üí database name to be created automatically
- `-p 3306:3306` ‚Üí exposes port 3306 for external connections
- `-d mysql:8` ‚Üí uses the official MySQL version 8 image

This will start a MySQL container accessible at `localhost:3306` with the database `ragdb` and password `1234`.

El comando para iniciar la app es:
```sh
node app.js
```

# RAGInternos - Documentaci√≥n T√©cnica y Arquitect√≥nica



## Visi√≥n General

RAGInternos es una API orientada a la gesti√≥n, procesamiento y consulta de documentos, con enfoque en la integraci√≥n de t√©cnicas de Recuperaci√≥n Aumentada por Generaci√≥n (RAG). El sistema permite almacenar, procesar, consultar y servir documentos, principalmente en formato PDF, y est√° preparado para integrarse con modelos de embeddings y flujos de procesamiento de lenguaje natural.

---

## Arquitectura General

La arquitectura de RAGInternos es modular y orientada a servicios. Utiliza Node.js y Express para exponer una API REST que gestiona documentos y metadatos almacenados en MySQL. Los archivos PDF se guardan en el sistema de archivos local. El sistema est√° preparado para integrarse con servicios de embeddings para procesamiento sem√°ntico, y cada componente tiene responsabilidades claras para facilitar la escalabilidad y el mantenimiento.

El sistema sigue una arquitectura modular basada en servicios, donde cada m√≥dulo se encarga de una responsabilidad espec√≠fica (gesti√≥n de documentos, procesamiento, almacenamiento, etc.). Utiliza Node.js como backend, Express para la gesti√≥n de rutas HTTP y MySQL como base de datos principal.

```mermaid
flowchart TD
    Client[Cliente/Frontend]
    API[API Express/Node.js]
    DB[(MySQL)]
    FS[FileSystem_PDFs]
    Embeddings[Servicio_de_Embeddings]
    Client -- "HTTP/REST" --> API
    API -- "SQL" --> DB
    API -- "Archivos" --> FS
    API -- "Embeddings API" --> Embeddings
```

---

## Componentes Principales

### 1. API Express

- Gestiona rutas para CRUD de documentos.
- Expone endpoints para subir, consultar, modificar y eliminar documentos.
- Sirve archivos PDF almacenados en el sistema de archivos.

### 2. Servicio de Documentos (`documentService.js`)

- L√≥gica de negocio para manipulaci√≥n de documentos.
- Interacci√≥n con la base de datos y el sistema de archivos.
- Serializaci√≥n/deserializaci√≥n de metadatos y tags.

### 3. Base de Datos MySQL

- Almacena metadatos de documentos.
- Estructura flexible para soportar tags, versiones y modelos de embeddings.

### 4. Sistema de Archivos

- Almacena los archivos PDF subidos.
- Integrado con la API para servir archivos bajo demanda.

### 5. Servicio de Embeddings (Integraci√≥n)

- Preparado para interactuar con modelos de embeddings (ej. OpenAI, local).
- Almacena informaci√≥n sobre el modelo usado y los tokens generados.

---

## Modelo de Datos

La tabla principal es `documents`, que contiene los siguientes campos clave:

- `id`: Identificador √∫nico.
- `title`, `file_name`, `description`, `author`, `category`
- `tags`: Array serializado en JSON.
- `source`, `language`, `upload_date`, `uploaded_by`
- `processed`, `total_chunks`, `total_tokens`
- `embedding_model`, `version`, `status`

```mermaid
erDiagram
    DOCUMENTS {
        int id PK
        string title
        string file_name
        string description
        string author
        string category
        string tags
        string source
        string language
        datetime upload_date
        string uploaded_by
        bool processed
        int total_chunks
        int total_tokens
        string embedding_model
        string version
        string status
    }
```

---

## Flujos de Procesos

### 1. Subida de Documento

```mermaid
sequenceDiagram
    participant User
    participant API
    participant FS as FileSystem
    participant DB as MySQL

    User->>API: POST /documents (con archivo PDF y metadatos)
    API->>FS: Guarda archivo PDF
    API->>DB: Inserta metadatos en documents
    API-->>User: Responde con ID y metadatos
```

### 2. Consulta de Documento

```mermaid
sequenceDiagram
    participant User
    participant API
    participant DB as MySQL

    User->>API: GET /documents/:id
    API->>DB: Consulta documento por ID
    API-->>User: Devuelve metadatos
```

### 3. Descarga de PDF

```mermaid
sequenceDiagram
    participant User
    participant API
    participant FS as FileSystem

    User->>API: GET /documents/:id/file
    API->>FS: Lee archivo PDF
    API-->>User: Env√≠a archivo PDF
```

---

## Integraciones y Dependencias

- **Node.js**: Entorno de ejecuci√≥n principal.
- **Express**: Framework para la API REST.
- **MySQL**: Base de datos relacional.
- **fs, path**: M√≥dulos nativos para manejo de archivos.
- **Servicios de Embeddings**: Integraci√≥n opcional para procesamiento sem√°ntico.

---

## Consideraciones de Seguridad

- Validaci√≥n de existencia de archivos antes de servirlos.
- Serializaci√≥n segura de campos como `tags`.
- Uso de par√°metros preparados en SQL para evitar inyecci√≥n.
- Control de acceso y autenticaci√≥n (a implementar seg√∫n necesidades).

---

## Escalabilidad y Mantenimiento

- Separaci√≥n de l√≥gica de negocio y acceso a datos.
- Preparado para integraci√≥n con servicios externos (embeddings, almacenamiento en la nube).
- Modularidad para facilitar pruebas y mantenimiento.
- Uso de paginaci√≥n en consultas para evitar sobrecarga.

---

## Diagramas Mermaid

### Arquitectura General

```mermaid
flowchart TD
    Client[Cliente/Frontend]
    API[API Express/Node.js]
    DB[(MySQL)]
    FS[FileSystem_PDFs]
    Embeddings[Servicio_de_Embeddings]
    Client -- "HTTP/REST" --> API
    API -- "SQL" --> DB
    API -- "Archivos" --> FS
    API -- "Embeddings API" --> Embeddings
```

### Modelo de Datos

```mermaid
erDiagram
    DOCUMENTS {
        int id PK
        string title
        string file_name
        string description
        string author
        string category
        string tags
        string source
        string language
        datetime upload_date
        string uploaded_by
        bool processed
        int total_chunks
        int total_tokens
        string embedding_model
        string version
        string status
    }
```

### Flujo de Subida de Documento

```mermaid
sequenceDiagram
    participant User
    participant API
    participant FS as FileSystem
    participant DB as MySQL

    User->>API: POST /documents (con archivo PDF y metadatos)
    API->>FS: Guarda archivo PDF
    API->>DB: Inserta metadatos en documents
    API-->>User: Responde con ID y metadatos
```

---

## Glosario

- **RAG**: Recuperaci√≥n Aumentada por Generaci√≥n.
- **Embeddings**: Representaciones vectoriales de texto para b√∫squeda sem√°ntica.
- **CRUD**: Operaciones de Crear, Leer, Actualizar y Eliminar.
- **API REST**: Interfaz de programaci√≥n de aplicaciones basada en HTTP.

---

> _Este documento debe mantenerse actualizado conforme evolucione la arquitectura y los componentes del sistema._